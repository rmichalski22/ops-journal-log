generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  admin
  editor
}

enum VisibilityMode {
  inherit
  public_internal
  restricted
}

enum NodeType {
  system
  service
  module
  other
}

enum ChangeType {
  feature
  fix
  migration
  config
  other
}

enum Impact {
  low
  medium
  high
}

enum RecordStatus {
  planned
  completed
  rolled_back
  monitoring
}

enum SubscriptionMode {
  immediate
  daily
  weekly
}

enum NotificationEventType {
  new_record
  edited_record
}

enum NotificationStatus {
  pending
  sent
  failed
}

enum AuditEventType {
  node_create
  node_rename
  node_move
  node_restrict
  node_delete
  record_create
  record_edit
  record_delete
  attachment_upload
  attachment_delete
  subscription_add
  subscription_remove
  notification_sent
  notification_failure
  login_success
  login_failure
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  role         Role     @default(editor)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  sessions             Session[]
  recordRevisions      RecordRevision[]
  subscriptions        Subscription[]
  auditEvents          AuditEvent[]        @relation("AuditEventActor")
  createdNodes         Node[]              @relation("NodeCreator")
  createdRecords       ChangeRecord[]      @relation("RecordCreator")
  updatedRecords       ChangeRecord[]      @relation("RecordUpdater")
  uploadedAttachments  Attachment[]        @relation("AttachmentUploader")
  notificationOutbox   NotificationOutbox[]
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Node {
  id             String         @id @default(cuid())
  parentId       String?
  name           String
  slug           String
  type           NodeType       @default(other)
  path           String
  pathIds        String[]       @default([])
  visibilityMode VisibilityMode @default(public_internal)
  allowedRoles   Role[]         @default([])
  createdById    String
  deletedAt      DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  parent     Node?   @relation("NodeHierarchy", fields: [parentId], references: [id])
  children   Node[]  @relation("NodeHierarchy")
  createdBy  User    @relation("NodeCreator", fields: [createdById], references: [id])
  records    ChangeRecord[]
  subscriptions Subscription[]

  @@unique([parentId, slug])
  @@index([parentId])
  @@index([deletedAt])
  @@index([path])
}

model ChangeRecord {
  id          String       @id @default(cuid())
  nodeId      String
  occurredAt  DateTime
  title       String
  description String       @db.Text
  reason      String?      @db.Text
  changeType  ChangeType   @default(other)
  impact      Impact       @default(medium)
  status      RecordStatus @default(planned)
  links       String[]     @default([])
  createdById String
  updatedById String?
  deletedAt   DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  node             Node               @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  createdBy        User               @relation("RecordCreator", fields: [createdById], references: [id])
  updatedBy        User?              @relation("RecordUpdater", fields: [updatedById], references: [id])
  revisions        RecordRevision[]
  attachments      Attachment[]
  notificationOutbox NotificationOutbox[]

  @@index([nodeId])
  @@index([occurredAt])
  @@index([status])
  @@index([deletedAt])
}

model RecordRevision {
  id             String   @id @default(cuid())
  recordId       String
  editorId       String
  snapshotBefore Json
  snapshotAfter  Json
  secretAck      Boolean? @default(false)
  createdAt      DateTime @default(now())

  record ChangeRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)
  editor User         @relation(fields: [editorId], references: [id])

  @@index([recordId])
}

model Attachment {
  id             String    @id @default(cuid())
  recordId       String
  filename       String
  mimeType       String
  sizeBytes      Int
  storageKey     String
  storageBackend String    @default("local")
  uploadedById   String
  deletedAt      DateTime?
  createdAt      DateTime  @default(now())

  record     ChangeRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)
  uploadedBy User         @relation("AttachmentUploader", fields: [uploadedById], references: [id])

  @@index([recordId])
}

model Subscription {
  id                 String           @id @default(cuid())
  userId             String
  nodeId             String
  includeDescendants Boolean          @default(true)
  notifyOnEdit       Boolean          @default(true)
  mode               SubscriptionMode @default(immediate)
  impactThreshold    Impact?
  createdAt          DateTime         @default(now())

  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  node               Node                @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  notificationOutbox NotificationOutbox[]

  @@unique([userId, nodeId])
  @@index([userId])
  @@index([nodeId])
}

model NotificationOutbox {
  id             String                  @id @default(cuid())
  userId         String
  recordId       String
  subscriptionId String?
  eventType      NotificationEventType
  status         NotificationStatus      @default(pending)
  scheduledAt    DateTime                @default(now())
  sentAt         DateTime?
  failedAt       DateTime?
  errorMessage   String?                 @db.Text

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  record       ChangeRecord  @relation(fields: [recordId], references: [id], onDelete: Cascade)
  subscription Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  @@index([status, scheduledAt])
  @@index([userId])
  @@index([subscriptionId])
}

model AuditEvent {
  id        String         @id @default(cuid())
  type      AuditEventType
  actorId   String?
  metadata  Json           @default("{}")
  createdAt DateTime       @default(now())

  actor User? @relation("AuditEventActor", fields: [actorId], references: [id], onDelete: SetNull)

  @@index([type])
  @@index([createdAt])
  @@index([actorId])
}
